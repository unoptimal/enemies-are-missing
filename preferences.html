<!doctype html>
<html>
  <head>
    <title>Preferences</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Helvetica, Arial, sans-serif;
        padding: 20px;
        margin: 0;
        background-color: #ffffff;
        -webkit-user-select: none;
      }

      .container {
        max-width: 340px;
        margin: 20px auto 0;
        padding: 20px 20px 12px;
      }

      .preference-group {
        margin-bottom: 24px;
      }

      .preference-title {
        font-weight: 600;
        margin-bottom: 12px;
        color: #333;
      }

      .volume-control {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 4px;
      }

      .size-control {
        display: flex;
        gap: 24px;
        padding: 4px 0;
      }

      .button-container {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
      }

      .titlebar {
        -webkit-app-region: drag;
        height: 38px;
        background: #f7f7f7;
        border-bottom: 1px solid #ddd;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .titlebar::after {
        content: 'Preferences';
        color: #666;
        font-size: 13px;
        font-weight: 500;
      }

      .shortcut-control {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .shortcut-display {
        flex-grow: 1;
        padding: 6px 12px;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-family:
          ui-monospace,
          SFMono-Regular,
          SF Mono,
          Menlo,
          monospace;
        color: #333;
      }

      .shortcut-display.recording {
        background: #007aff15;
        border-color: #007aff;
        color: #007aff;
      }

      button {
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid #ddd;
        background: #ffffff;
        font-size: 13px;
        cursor: pointer;
      }

      button.primary {
        background: #007aff;
        color: white;
        border-color: #0051b3;
      }

      button:active {
        opacity: 0.8;
      }

      .hint {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
      }

      .slider {
        flex-grow: 1;
        height: 4px;
        border-radius: 2px;
        background: #ddd;
        outline: none;
        -webkit-appearance: none;
      }

      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #007aff;
        cursor: pointer;
      }

      .volume-value {
        font-family:
          ui-monospace,
          SFMono-Regular,
          SF Mono,
          Menlo,
          monospace;
        color: #666;
        min-width: 4em;
      }

      .size-option {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
      }

      .size-option input[type='radio'] {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div class="titlebar"></div>
    <div class="container">
      <div class="preference-group">
        <div class="preference-title">Shortcut Key</div>
        <div class="shortcut-control">
          <div id="shortcutDisplay" class="shortcut-display">Loading...</div>
          <button id="recordBtn">Record</button>
        </div>
        <div class="hint">
          Click 'Record' and press your desired key combination. Click 'Stop'
          when done.
        </div>
      </div>

      <div class="preference-group">
        <div class="preference-title">Volume</div>
        <div class="volume-control">
          <input
            type="range"
            id="volumeSlider"
            min="0"
            max="100"
            step="1"
            value="50"
            class="slider"
          />
          <span id="volumeValue" class="volume-value">50%</span>
        </div>
        <div class="hint">Adjust the volume of the ping sound</div>
      </div>

      <div class="preference-group">
        <div class="preference-title">Ping Size</div>
        <div class="size-control">
          <label class="size-option">
            <input type="radio" name="size" value="small" />
            <span>Small</span>
          </label>
          <label class="size-option">
            <input type="radio" name="size" value="medium" />
            <span>Medium</span>
          </label>
          <label class="size-option">
            <input type="radio" name="size" value="large" />
            <span>Large</span>
          </label>
        </div>
        <div class="hint">Select the size of the ping indicator</div>
      </div>

      <div class="button-container">
        <button id="cancelBtn">Cancel</button>
        <button id="saveBtn" class="primary">Save</button>
      </div>
    </div>
    <script>
      const { ipcRenderer } = require('electron')
      const shortcutDisplay = document.getElementById('shortcutDisplay')
      const recordBtn = document.getElementById('recordBtn')
      const saveBtn = document.getElementById('saveBtn')
      const cancelBtn = document.getElementById('cancelBtn')

      let isRecording = false
      let currentShortcut = ''
      let newShortcut = ''

      ipcRenderer.invoke('get-shortcut').then(shortcut => {
        currentShortcut = shortcut
        shortcutDisplay.textContent = shortcut
      })

      recordBtn.addEventListener('click', () => {
        if (!isRecording) {
          isRecording = true
          recordBtn.textContent = 'Stop'
          shortcutDisplay.classList.add('recording')
          shortcutDisplay.textContent = 'Type your shortcut...'
          ipcRenderer.send('start-recording')
        } else {
          stopRecording()
        }
      })

      function stopRecording() {
        isRecording = false
        recordBtn.textContent = 'Record'
        shortcutDisplay.classList.remove('recording')
        ipcRenderer.send('stop-recording')
      }

      ipcRenderer.on('shortcut-recording', (_, shortcut) => {
        if (isRecording) {
          shortcutDisplay.textContent =
            shortcut || 'Type your shortcut or click mouse buttons...'
        }
      })

      ipcRenderer.on('shortcut-recorded', (_, shortcut) => {
        newShortcut = shortcut
        shortcutDisplay.textContent = shortcut
      })

      cancelBtn.addEventListener('click', () => {
        if (isRecording) {
          stopRecording()
        }
        shortcutDisplay.textContent = currentShortcut
        ipcRenderer.send('close-preferences')
      })

      window.addEventListener('beforeunload', () => {
        if (isRecording) {
          stopRecording()
        }
      })

      const volumeSlider = document.getElementById('volumeSlider')
      const volumeValue = document.getElementById('volumeValue')

      function percentToGain(percent) {
        if (percent <= 50) {
          return (percent / 50) * 15
        } else {
          return 15 + ((percent - 50) / 50) * 15
        }
      }

      function gainToPercent(gain) {
        if (gain <= 15) {
          return (gain / 15) * 50
        } else {
          return 50 + ((gain - 15) / 15) * 50
        }
      }

      volumeSlider.addEventListener('input', () => {
        const percent = parseInt(volumeSlider.value)
        const gain = percentToGain(percent)
        volumeValue.textContent = `${percent}%`
        ipcRenderer.send('set-volume', gain)
      })

      ipcRenderer.invoke('get-volume').then(gain => {
        const percent = Math.round(gainToPercent(gain))
        volumeSlider.value = percent
        volumeValue.textContent = `${percent}%`
      })

      const sizeInputs = document.querySelectorAll('input[name="size"]')

      ipcRenderer.invoke('get-size').then(size => {
        const radio = document.querySelector(`input[value="${size}"]`)
        if (radio) radio.checked = true
      })

      sizeInputs.forEach(input => {
        input.addEventListener('change', e => {
          if (e.target.checked) {
            ipcRenderer.send('set-size', e.target.value)
          }
        })
      })

      saveBtn.addEventListener('click', () => {
        if (newShortcut) {
          ipcRenderer.send('set-shortcut', newShortcut)
        }
        const percent = parseInt(volumeSlider.value)
        const gain = percentToGain(percent)
        ipcRenderer.send('set-volume', gain)
        const selectedSize = document.querySelector(
          'input[name="size"]:checked'
        ).value
        ipcRenderer.send('set-size', selectedSize)
        ipcRenderer.send('close-preferences')
      })
    </script>
  </body>
</html>
